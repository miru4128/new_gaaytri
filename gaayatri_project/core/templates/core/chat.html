{% extends 'core/base.html' %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Chat with <span class="text-success">{{ other_user.username }}</span></h4>
        <a href="{% if user.is_doctor %}{% url 'inbox' %}{% else %}{% url 'doctor_list' %}{% endif %}" class="btn btn-sm btn-outline-secondary">Back</a>
    </div>

    <div class="card shadow-sm border-0 mb-3" style="height: 500px; overflow-y: scroll; background-color: #f3f4f6;">
        <div class="card-body">
            {% for msg in messages %}
                <div class="d-flex mb-3 {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                    <div class="p-3 rounded-3 shadow-sm {% if msg.sender == user %}bg-success text-white sent-message{% else %}bg-white received-message{% endif %}" style="max-width: 70%;">
                        
                        {% if msg.image %}
                            <img src="{{ msg.image.url }}" class="img-fluid rounded mb-2" style="max-height: 200px;">
                        {% endif %}
                        
                        {% if msg.body %}
                            <p class="mb-1">{{ msg.body }}</p>
                        {% endif %}
                        
                        <small style="font-size: 0.7rem; opacity: 0.8; display: block; text-align: right;">
                            {{ msg.timestamp|time:"H:i" }}
                        </small>
                    </div>
                </div>
            {% empty %}
                <p class="text-center text-muted mt-5">No messages yet. Say hello!</p>
            {% endfor %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="d-flex gap-2">
        {% csrf_token %}
        <div class="flex-grow-1">
            {{ form.body }}
        </div>
        <div style="width: 50px; overflow: hidden;">
             {{ form.image }}
        </div>
        <button type="submit" class="btn btn-gaayatri"><i class="bi bi-send-fill"></i> Send</button>
    </form>
    <small class="text-muted">Use the "Choose File" button to upload an image.</small>
</div>
{% endblock %}